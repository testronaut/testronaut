name: Cursor Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  cursor:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@cursor')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@cursor')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@cursor')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@cursor') || contains(github.event.issue.title, '@cursor')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set prompt from event
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body;
            if (context.eventName === 'issue_comment' || context.eventName === 'pull_request_review_comment') {
              body = context.payload.comment.body;
            } else if (context.eventName === 'pull_request_review') {
              body = context.payload.review.body;
            } else {
              body = (context.payload.issue.body || '') + '\n\nTitle: ' + (context.payload.issue.title || '');
            }
            // Strip @cursor and surrounding whitespace for a cleaner prompt
            const prompt = body.replace(/@cursor\s*/gi, '').trim() || 'Perform the task requested in the comment or issue.';
            fs.writeFileSync(process.env.GITHUB_WORKSPACE + '/.cursor-prompt.txt', prompt);

      - name: Install Cursor CLI
        run: |
          curl -fsSL https://cursor.com/install | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Run Cursor Agent
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          export PATH="$HOME/.cursor/bin:$PATH"
          agent -p "$(cat .cursor-prompt.txt)"
